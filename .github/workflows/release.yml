name: Release APK (Obfuscated)

on:
  push:
    branches:
      - "feature/**"
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "要构建的 tag 名称（如 v0.3）"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    env:
      # Push: use ref name (branch/tag). Dispatch: use input tag.
      RELEASE_REF: ${{ github.event.inputs.tag || github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.9"
          channel: stable
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get --enforce-lockfile

      - name: Resolve build metadata
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF}" == refs/tags/v* || "${RELEASE_REF}" == v* ]]; then
            # Tag build: v0.4.2 -> 0.4.2
            VERSION="${RELEASE_REF#v}"
            LABEL="${RELEASE_REF}"
          else
            # Branch build: use pubspec version name and a sanitized branch label.
            VERSION="$(sed -nE "s/^version:[[:space:]]*([0-9]+\\.[0-9]+\\.[0-9]+)\\+[0-9]+$/\\1/p" pubspec.yaml)"
            if [[ -z "$VERSION" ]]; then
              echo "::error::Failed to parse semantic version from pubspec.yaml"
              exit 1
            fi
            LABEL="$(echo "${RELEASE_REF}" | tr '/ ' '--')"
          fi

          echo "BUILD_NAME=$VERSION" >> "$GITHUB_ENV"
          echo "BUILD_NUMBER=${{ github.run_number }}" >> "$GITHUB_ENV"
          echo "RELEASE_LABEL=$LABEL" >> "$GITHUB_ENV"
          echo "Version: $VERSION, Build number: ${{ github.run_number }}, Label: $LABEL"

      - name: Resolve release notes from tag
        if: startsWith(github.ref, 'refs/tags/v') || startsWith(github.event.inputs.tag, 'v')
        shell: bash
        run: |
          set -euo pipefail
          # release notes：优先用文件，不存在则用 tag 所在 commit message
          NOTES_FILE="release-notes/${RELEASE_REF}.md"
          if [[ -f "$NOTES_FILE" ]]; then
            echo "RELEASE_NOTES_FILE=$NOTES_FILE" >> "$GITHUB_ENV"
            echo "Using release notes from file: $NOTES_FILE"
          else
            echo "No release notes file found, using commit message."
            FALLBACK_FILE="release-notes/_auto_generated.md"
            git log -1 --format='%B' > "$FALLBACK_FILE"
            echo "RELEASE_NOTES_FILE=$FALLBACK_FILE" >> "$GITHUB_ENV"
          fi

      - name: Build Obfuscated Plugin APKs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets
          mkdir -p build/symbols

          build_variant() {
            local target_platform="$1"
            local source_apk="$2"
            local output_name="$3"
            local symbol_dir="$4"

            echo "Building: $output_name (version=${BUILD_NAME}+${BUILD_NUMBER})"
            flutter build apk \
              --release \
              --split-per-abi \
              --target-platform "$target_platform" \
              --build-name="${BUILD_NAME}" \
              --build-number="${BUILD_NUMBER}" \
              --dart-define=ENABLE_PLUGINS=true \
              --android-skip-build-dependency-validation \
              --obfuscate \
              --split-debug-info="build/symbols/$symbol_dir"

            cp "build/app/outputs/flutter-apk/$source_apk" "release-assets/$output_name"
          }

          build_variant "android-arm" "app-armeabi-v7a-release.apk" "v7a.apk" "v7a-on"
          build_variant "android-arm64" "app-arm64-v8a-release.apk" "v8a.apk" "v8a-on"

      - name: Generate APK checksums and size report
        shell: bash
        run: |
          set -euo pipefail
          echo "APK size report:"
          ls -lh release-assets/*.apk
          sha256sum release-assets/v7a.apk release-assets/v8a.apk > release-assets/SHA256SUMS.txt
          cat release-assets/SHA256SUMS.txt

      - name: Upload v7a APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: v7a-${{ env.RELEASE_LABEL }}
          path: release-assets/v7a.apk
          if-no-files-found: error

      - name: Upload v8a APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: v8a-${{ env.RELEASE_LABEL }}
          path: release-assets/v8a.apk
          if-no-files-found: error

      - name: Upload Symbols Artifact
        uses: actions/upload-artifact@v4
        with:
          name: symbols-${{ env.RELEASE_LABEL }}
          path: build/symbols
          if-no-files-found: error

      - name: Upload SHA256 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksums-${{ env.RELEASE_LABEL }}
          path: release-assets/SHA256SUMS.txt
          if-no-files-found: error

      - name: Upload APKs to Cloudflare R2 (optional)
        if: startsWith(github.ref, 'refs/tags/v') || startsWith(github.event.inputs.tag, 'v')
        shell: bash
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ vars.R2_BUCKET || secrets.R2_BUCKET }}
          R2_PREFIX: ${{ vars.R2_PREFIX }}
          R2_PUBLIC_BASE: ${{ vars.R2_PUBLIC_BASE }}
        run: |
          set -euo pipefail
          BODY_FILE="release-assets/release-body.md"
          NOTES_FILE="${RELEASE_NOTES_FILE:-}"
          if [[ -z "$NOTES_FILE" || ! -f "$NOTES_FILE" ]]; then
            NOTES_FILE="release-notes/_auto_generated.md"
            git log -1 --format='%B' > "$NOTES_FILE"
          fi
          cp "$NOTES_FILE" "$BODY_FILE"

          if [[ -z "${R2_ACCOUNT_ID:-}" || -z "${R2_ACCESS_KEY_ID:-}" || -z "${R2_SECRET_ACCESS_KEY:-}" || -z "${R2_BUCKET:-}" ]]; then
            echo "R2 not fully configured, skipping R2 upload."
            echo "RELEASE_BODY_FILE=$BODY_FILE" >> "$GITHUB_ENV"
            exit 0
          fi

          if ! command -v aws >/dev/null 2>&1; then
            echo "::warning::aws cli not found, skipping R2 upload."
            echo "RELEASE_BODY_FILE=$BODY_FILE" >> "$GITHUB_ENV"
            exit 0
          fi

          export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
          export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"
          export AWS_DEFAULT_REGION="auto"

          ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
          PREFIX="${R2_PREFIX:-releases}/${RELEASE_REF}"

          aws s3 cp "release-assets/v7a.apk" "s3://${R2_BUCKET}/${PREFIX}/v7a.apk" --endpoint-url "$ENDPOINT" --only-show-errors
          aws s3 cp "release-assets/v8a.apk" "s3://${R2_BUCKET}/${PREFIX}/v8a.apk" --endpoint-url "$ENDPOINT" --only-show-errors
          aws s3 cp "release-assets/SHA256SUMS.txt" "s3://${R2_BUCKET}/${PREFIX}/SHA256SUMS.txt" --endpoint-url "$ENDPOINT" --only-show-errors

          PUBLIC_BASE="${R2_PUBLIC_BASE:-https://${R2_BUCKET}.${R2_ACCOUNT_ID}.r2.dev}"
          V7A_URL="${PUBLIC_BASE}/${PREFIX}/v7a.apk"
          V8A_URL="${PUBLIC_BASE}/${PREFIX}/v8a.apk"
          SUMS_URL="${PUBLIC_BASE}/${PREFIX}/SHA256SUMS.txt"

          {
            echo
            echo "## Mirror Download (Cloudflare R2)"
            echo "- v7a.apk: ${V7A_URL}"
            echo "- v8a.apk: ${V8A_URL}"
            echo "- SHA256SUMS.txt: ${SUMS_URL}"
          } >> "$BODY_FILE"

          echo "RELEASE_BODY_FILE=$BODY_FILE" >> "$GITHUB_ENV"
          echo "R2 upload done."

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/v') || startsWith(github.event.inputs.tag, 'v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_REF }}
          name: ${{ env.RELEASE_REF }}
          body_path: ${{ env.RELEASE_BODY_FILE || env.RELEASE_NOTES_FILE }}
          files: |
            release-assets/v7a.apk
            release-assets/v8a.apk
            release-assets/SHA256SUMS.txt

      # ============ Gitee 镜像发布（可选，需配置 GITEE_TOKEN 和 GITEE_REPO） ============
      - name: Publish to Gitee
        if: startsWith(github.ref, 'refs/tags/v') || startsWith(github.event.inputs.tag, 'v')
        shell: bash
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ vars.GITEE_REPO }}
        run: |
          if [[ -z "$GITEE_TOKEN" || -z "$GITEE_REPO" ]]; then
            echo "Gitee not configured, skipping."
            exit 0
          fi
          set -euo pipefail
          API="https://gitee.com/api/v5/repos/${GITEE_REPO}/releases"
          BODY_FILE="${RELEASE_BODY_FILE:-$RELEASE_NOTES_FILE}"
          RELEASE_ID=""
          create_gitee_release() {
            echo "Creating Gitee release for ${RELEASE_REF}..."
            payload_file="$(mktemp)"
            create_resp="$(mktemp)"
            create_err="$(mktemp)"

            python3 -c 'import json,sys,pathlib; body=pathlib.Path(sys.argv[2]).read_text(encoding="utf-8"); print(json.dumps({"tag_name":sys.argv[1],"name":sys.argv[1],"body":body,"target_commitish":"main"}, ensure_ascii=False))' "$RELEASE_REF" "$BODY_FILE" > "$payload_file"

            create_http="$(curl -sS --connect-timeout 15 --max-time 60 \
              --retry 2 --retry-delay 3 --retry-all-errors \
              -o "$create_resp" -w "%{http_code}" \
              -X POST "${API}?access_token=${GITEE_TOKEN}" \
              -H "Content-Type: application/json" \
              --data @"$payload_file" 2>"$create_err" || true)"

            if [[ "$create_http" =~ ^2[0-9][0-9]$ ]]; then
              RELEASE_ID=$(python3 -c 'import json,sys; d=json.load(sys.stdin); print(d.get("id",""))' < "$create_resp" 2>/dev/null || true)
              echo "Gitee release created: ID=$RELEASE_ID"
            else
              echo "::warning::Failed to create Gitee release (HTTP ${create_http})."
              echo "Curl stderr:"
              cat "$create_err"
              echo "Response:"
              cat "$create_resp"
            fi

            rm -f "$payload_file" "$create_resp" "$create_err"
          }

          # 1) Prefer querying release by tag: exists -> reuse ID
          query_resp="$(mktemp)"
          query_err="$(mktemp)"
          query_http="$(curl -sS --connect-timeout 15 --max-time 30 \
            -o "$query_resp" -w "%{http_code}" \
            "${API}/tags/${RELEASE_REF}?access_token=${GITEE_TOKEN}" 2>"$query_err" || true)"

          if [[ "$query_http" == "200" ]]; then
            RELEASE_ID=$(python3 -c 'import json,sys; d=json.load(sys.stdin); print(d.get("id","") if isinstance(d,dict) else "")' < "$query_resp" 2>/dev/null || true)
            if [[ -n "$RELEASE_ID" ]]; then
              echo "Using existing Gitee release: ID=$RELEASE_ID"
            else
              echo "::warning::Query by tag returned HTTP 200 but no release id. Fallback to release list lookup."
              list_release_resp="$(mktemp)"
              list_release_err="$(mktemp)"
              list_release_http="$(curl -sS --connect-timeout 15 --max-time 30 \
                -o "$list_release_resp" -w "%{http_code}" \
                "${API}?access_token=${GITEE_TOKEN}&page=1&per_page=100" 2>"$list_release_err" || true)"
              if [[ "$list_release_http" == "200" ]]; then
                RELEASE_ID=$(python3 -c 'import json,sys; tag=sys.argv[1]; data=json.load(sys.stdin); print(next((str(i.get("id","")) for i in data if isinstance(i,dict) and i.get("tag_name")==tag),"") if isinstance(data,list) else "")' "$RELEASE_REF" < "$list_release_resp" 2>/dev/null || true)
                if [[ -n "$RELEASE_ID" ]]; then
                  echo "Using existing Gitee release from list: ID=$RELEASE_ID"
                else
                  echo "::warning::Release list lookup still found no id for tag ${RELEASE_REF}. Will try create."
                  echo "Query-by-tag response:"
                  cat "$query_resp"
                  create_gitee_release
                fi
              else
                echo "::warning::Failed to list releases for fallback (HTTP ${list_release_http})."
                echo "Curl stderr:"
                cat "$list_release_err"
              fi
              rm -f "$list_release_resp" "$list_release_err"
            fi
          elif [[ "$query_http" == "404" ]]; then
            echo "No Gitee release for ${RELEASE_REF}, creating..."
            create_gitee_release
          else
            echo "::warning::Failed to query Gitee release by tag (HTTP ${query_http})."
            echo "Curl stderr:"
            cat "$query_err"
            echo "Response:"
            cat "$query_resp"
          fi

          rm -f "$query_resp" "$query_err"

          if [[ -z "$RELEASE_ID" || ! "$RELEASE_ID" =~ ^[0-9]+$ ]]; then
            echo "::warning::Invalid or empty Gitee release id: '${RELEASE_ID}', skipping asset upload."
            exit 0
          fi

          for apk in release-assets/v7a.apk release-assets/v8a.apk; do
            apk_name="$(basename "$apk")"
            echo "Uploading ${apk_name} to Gitee..."

            # If the same filename already exists, delete it first to avoid conflicts.
            list_resp="$(mktemp)"
            list_err="$(mktemp)"
            list_http="$(curl -sS --connect-timeout 15 --max-time 30 \
              -o "$list_resp" -w "%{http_code}" \
              "${API}/${RELEASE_ID}/attach_files?access_token=${GITEE_TOKEN}" 2>"$list_err" || true)"
            if [[ "$list_http" == "200" ]]; then
              old_attach_id="$(python3 -c 'import json,sys; name=sys.argv[1]; data=json.load(sys.stdin); print(next((str(i.get("id","")) for i in data if isinstance(i,dict) and i.get("name")==name),""))' "$apk_name" < "$list_resp" 2>/dev/null || true)"
              if [[ -n "$old_attach_id" ]]; then
                del_resp="$(mktemp)"
                del_err="$(mktemp)"
                del_http="$(curl -sS --connect-timeout 15 --max-time 30 \
                  -o "$del_resp" -w "%{http_code}" \
                  -X DELETE "${API}/${RELEASE_ID}/attach_files/${old_attach_id}?access_token=${GITEE_TOKEN}" 2>"$del_err" || true)"
                if [[ "$del_http" =~ ^2[0-9][0-9]$ ]]; then
                  echo "Deleted existing attachment: ${apk_name} (id=${old_attach_id})"
                else
                  echo "::warning::Failed to delete existing attachment ${apk_name} (HTTP ${del_http})"
                  echo "Delete response:"
                  cat "$del_resp"
                fi
                rm -f "$del_resp" "$del_err"
              fi
            fi
            rm -f "$list_resp" "$list_err"

            resp_file="$(mktemp)"
            err_file="$(mktemp)"
            curl_exit=0
            http_code="$(curl -sS \
              --connect-timeout 30 \
              --max-time 60 \
              --retry 3 \
              --retry-delay 5 \
              --retry-all-errors \
              -o "$resp_file" \
              -w "%{http_code}" \
              -X POST "${API}/${RELEASE_ID}/attach_files" \
              -F "access_token=${GITEE_TOKEN}" \
              -F "file=@${apk}" 2>"$err_file")" || curl_exit=$?

            if [[ $curl_exit -ne 0 ]]; then
              echo "::warning::Failed to upload ${apk_name} to Gitee (curl exit=${curl_exit})"
              echo "Curl stderr:"
              cat "$err_file"
              echo "Response:"
              cat "$resp_file"
            elif [[ "$http_code" =~ ^2[0-9][0-9]$ ]]; then
              echo "Upload OK: ${apk_name} (HTTP ${http_code})"
            else
              echo "::warning::Failed to upload ${apk_name} to Gitee (HTTP ${http_code})"
              echo "Response:"
              cat "$resp_file"
            fi

            rm -f "$resp_file" "$err_file"
          done
          echo "Gitee publish done."