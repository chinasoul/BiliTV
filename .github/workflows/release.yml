name: Release APK (Obfuscated)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "要构建的 tag 名称（如 v0.3）"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    env:
      # 统一 tag 名：push tag 时用 GITHUB_REF_NAME，手动触发时用 inputs.tag
      RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.9"
          channel: stable
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get --enforce-lockfile

      - name: Resolve version & release notes from tag
        shell: bash
        run: |
          set -euo pipefail

          # 从 tag 提取版本号：v0.4.2 → 0.4.2
          VERSION="${RELEASE_TAG#v}"
          if [[ -z "$VERSION" ]]; then
            echo "::error::Unable to extract version from tag '${RELEASE_TAG}'"
            exit 1
          fi
          echo "BUILD_NAME=$VERSION" >> "$GITHUB_ENV"
          echo "BUILD_NUMBER=${{ github.run_number }}" >> "$GITHUB_ENV"
          echo "Version: $VERSION, Build number: ${{ github.run_number }}"

          # release notes：优先用文件，不存在则用 tag 所在 commit message
          NOTES_FILE="release-notes/${RELEASE_TAG}.md"
          if [[ -f "$NOTES_FILE" ]]; then
            echo "RELEASE_NOTES_FILE=$NOTES_FILE" >> "$GITHUB_ENV"
            echo "Using release notes from file: $NOTES_FILE"
          else
            echo "No release notes file found, using commit message."
            FALLBACK_FILE="release-notes/_auto_generated.md"
            git log -1 --format='%B' > "$FALLBACK_FILE"
            echo "RELEASE_NOTES_FILE=$FALLBACK_FILE" >> "$GITHUB_ENV"
          fi

      - name: Build Obfuscated Plugin APKs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets
          mkdir -p build/symbols

          build_variant() {
            local target_platform="$1"
            local source_apk="$2"
            local output_name="$3"
            local symbol_dir="$4"

            echo "Building: $output_name (version=${BUILD_NAME}+${BUILD_NUMBER})"
            flutter build apk \
              --release \
              --split-per-abi \
              --target-platform "$target_platform" \
              --build-name="${BUILD_NAME}" \
              --build-number="${BUILD_NUMBER}" \
              --dart-define=ENABLE_PLUGINS=true \
              --obfuscate \
              --split-debug-info="build/symbols/$symbol_dir"

            cp "build/app/outputs/flutter-apk/$source_apk" "release-assets/$output_name"
          }

          build_variant "android-arm" "app-armeabi-v7a-release.apk" "v7a.apk" "v7a-on"
          build_variant "android-arm64" "app-arm64-v8a-release.apk" "v8a.apk" "v8a-on"

      - name: Generate APK checksums and size report
        shell: bash
        run: |
          set -euo pipefail
          echo "APK size report:"
          ls -lh release-assets/*.apk
          sha256sum release-assets/v7a.apk release-assets/v8a.apk > release-assets/SHA256SUMS.txt
          cat release-assets/SHA256SUMS.txt

      - name: Upload v7a APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: v7a-${{ env.RELEASE_TAG }}
          path: release-assets/v7a.apk
          if-no-files-found: error

      - name: Upload v8a APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: v8a-${{ env.RELEASE_TAG }}
          path: release-assets/v8a.apk
          if-no-files-found: error

      - name: Upload Symbols Artifact
        uses: actions/upload-artifact@v4
        with:
          name: symbols-${{ env.RELEASE_TAG }}
          path: build/symbols
          if-no-files-found: error

      - name: Upload SHA256 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksums-${{ env.RELEASE_TAG }}
          path: release-assets/SHA256SUMS.txt
          if-no-files-found: error

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          body_path: ${{ env.RELEASE_NOTES_FILE }}
          files: |
            release-assets/v7a.apk
            release-assets/v8a.apk
            release-assets/SHA256SUMS.txt

      # ============ Gitee 镜像发布（可选，需配置 GITEE_TOKEN 和 GITEE_REPO） ============
      - name: Publish to Gitee
        shell: bash
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ vars.GITEE_REPO }}
        run: |
          if [[ -z "$GITEE_TOKEN" || -z "$GITEE_REPO" ]]; then
            echo "Gitee not configured, skipping."
            exit 0
          fi
          set -euo pipefail
          API="https://gitee.com/api/v5/repos/${GITEE_REPO}/releases"
          BODY=$(cat "$RELEASE_NOTES_FILE")

          echo "Creating Gitee release for ${RELEASE_TAG}..."
          RELEASE_RESP=$(curl -s --connect-timeout 15 --max-time 30 -X POST "$API" \
            -F "access_token=${GITEE_TOKEN}" \
            -F "tag_name=${RELEASE_TAG}" \
            -F "name=${RELEASE_TAG}" \
            -F "body=${BODY}" \
            -F "target_commitish=main")

          RELEASE_ID=$(echo "$RELEASE_RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])" 2>/dev/null || true)
          if [[ -z "$RELEASE_ID" ]]; then
            echo "::warning::Failed to create Gitee release. Response: $RELEASE_RESP"
            exit 0
          fi
          echo "Gitee release created: ID=$RELEASE_ID"

          for apk in release-assets/v7a.apk release-assets/v8a.apk; do
            echo "Uploading $(basename $apk) to Gitee..."
            UPLOAD_RESP=$(curl -sS --connect-timeout 15 --max-time 120 \
              -X POST "${API}/${RELEASE_ID}/attach_files" \
              -F "access_token=${GITEE_TOKEN}" \
              -F "file=@${apk}") \
              && echo "Upload OK: $(basename $apk)" \
              || echo "::warning::Failed to upload $(basename $apk) to Gitee"
            echo "Response: $UPLOAD_RESP"
          done
          echo "Gitee publish done."
