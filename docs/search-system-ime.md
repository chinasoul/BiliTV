# 搜索框改造与焦点流程（中文沉淀）

## 一句话结论

搜索页从“仅虚拟键盘输入”升级为“系统输入法 + 虚拟键盘并存”，同时按 TV 视觉路径修正 dpad 焦点移动，避免输入法退出后焦点丢失或方向键失效。

## 背景与目标

原搜索页顶部只是展示文本，不是可编辑输入框，所以无法调起系统输入法。  
本轮改造目标：

- 搜索框可直接输入（系统输入法可用）。
- 保留虚拟键盘输入路径（兼容遥控器场景）。
- 焦点移动符合“视觉相邻”逻辑，减少用户迷失。
- 输入法退出后保持可继续导航，不出现“焦点在框里但方向键失效”。

## 涉及文件

- `lib/screens/home/search/search_keyboard_view.dart`
- `lib/screens/home/search_tab.dart`
- `lib/screens/home_screen.dart`

## 改造过程（按问题演进）

### 1) 可输入 + 调起系统输入法

- 将原展示容器改为真实输入控件（可编辑）。
- 输入框激活时调用系统输入法。
- 文本状态与原搜索逻辑保持同步（搜索历史、进入结果页、建议词请求）。

### 2) 导航栏右键进入点修正

- 曾出现“右键默认进输入框”导致与历史习惯不一致。
- 最终回归为从侧栏搜索图标右键进入键盘区默认入口（非强制进输入框）。

### 3) 视觉移动逻辑修正

- 第一排字母键上移不再直接跳输入框。
- 改为视觉相邻路径：
  - 第一排字母 -> 上方动作行（清空/后退）
  - 动作行再上移 -> 输入框

### 4) 输入法退出后焦点与方向键问题

- 出现过“输入法退出后焦点位置不稳定”与“焦点在输入框但方向键无效”。
- 处理思路：
  - 输入法关闭后若搜索区无有效焦点，兜底回输入框；
  - 显式处理输入框方向键（避免被文本光标逻辑吞掉）。

## 当前期望的焦点规则（以后改动默认遵循）

### 入口

- 侧栏聚焦 `搜索` 图标后按右键：进入搜索页默认键位（键盘区入口）。

### 键盘区到输入框

- 第一排字母键按上：先到动作行（清空/后退，按视觉相邻）。
- `清空/后退` 再按上：进入输入框（并弹系统输入法）。

### 输入框方向键

- 左键：回侧栏搜索图标。
- 下键：回动作行/键盘区。
- 上键：阻止（不跨区乱跳）。

### 返回键

- 在结果页：返回到搜索输入态。
- 在输入态：返回到主页侧栏。

## 常见回退风险（下次改动先看）

- 把“第一排字母上移”直接连到输入框，会破坏视觉链路。
- 只处理输入法弹起，不处理输入法退出，容易出现焦点丢失。
- 输入框焦点在 `TextField` 时未接管方向键，容易出现 dpad 看似失效。
- 侧栏 `Search` 的右键入口若未显式绑定，可能无法稳定进入搜索内容区。

## 最小回归清单（提测用）

1. 侧栏搜索图标右键能进入搜索页（默认入口正确）。
2. 按视觉路径可到输入框：第一排字母 -> 动作行 -> 输入框。
3. 输入框聚焦能弹系统输入法。
4. 关闭输入法后，焦点仍在可预期位置且方向键可用。
5. 返回键在“结果页/输入页”行为分别正确。
6. 搜索提交后历史记录与结果页跳转正常。

## 下次沟通可直接复用的简版（节省 token）

可直接贴下面这段作为需求说明：

> 搜索页保持“系统输入法 + 虚拟键盘并存”。  
> 侧栏搜索右键进入默认键盘入口，不直接进输入框。  
> 焦点视觉链路：第一排字母上移到清空/后退，再上移到输入框。  
> 输入框左回侧栏、下回键盘、上阻止。  
> 输入法退出后若焦点丢失，兜底回输入框，并保证 dpad 方向键可用。  
> 返回键：结果页回输入页，输入页回侧栏。

## Token 节省粗估

- 无文档复盘：约 `1000~1800` tokens/次（来回确认+修正）。
- 引用本文档：约 `300~700` tokens/次。
- 单次预计节省：`700~1100` tokens。

## 包体影响记录（本次）

- 本次搜索框改造后，单 ABI APK 体积约增加 `0.6MB`（历史对比口径）。
- 该增量已确认与搜索页系统输入法相关改动有关（非多 ABI 叠加问题）。
- 当前已采用发布侧缓解方案（`obfuscate + split-debug-info + useLegacyPackaging`）降低分发下载体积。
